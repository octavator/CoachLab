var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}import Modal from'./modal.js';import Navbar from'./navbar.js';var Agenda=function(_React$Component){_inherits(Agenda,_React$Component);function Agenda(props){_classCallCheck(this,Agenda);var _this=_possibleConstructorReturn(this,(Agenda.__proto__||Object.getPrototypeOf(Agenda)).call(this,props));_this.state={new_resa_modal:false,appointment_details_modal:false,target_id:undefined,schedule:{},day:new Date(new Date().setHours(0,0,0,0)),month:new Date().getMonth(),year:new Date().getFullYear(),showFlash:false,flashType:'',flashMessage:'',appointment_detailed:{},form:{duration:'30',isVideo:true,id:''},user:{firstname:'',lastname:''},target_user:{firstname:'',lastname:''},weekdays:['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'],hours:['8','9','10','11','12','13','14','15','16','17','18','19','20','21'],months:['Janvier','F\xE9vrier','Mars','Avril','Mai','Juin','Juillet','Ao\xFBt','Septembre','Octobre','Novembre','D\xE9cembre']};return _this}_createClass(Agenda,[{key:'componentDidMount',value:function componentDidMount(){var _this2=this;var urlParams=new URLSearchParams(document.location.search);var target_id=urlParams.get('target_id');if(!target_id){http.get('/me/agenda').then(function(agendaData){_this2.setState({schedule:agendaData.data.agenda})}).catch(function(err){_this2.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}else{http.get('/me').then(function(res){_this2.setState({user:res.data});http.get('/coach/agenda/'+target_id).then(function(agendaData){_this2.setState({target_user:agendaData.data.user,schedule:agendaData.data.agenda,target_id:target_id})}).catch(function(err){_this2.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}).catch(function(err){_this2.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}}},{key:'showFlashMessage',value:function showFlashMessage(type,message){var _this3=this;this.setState({showFlash:true,flashMessage:message,flashType:type},function(){setTimeout(function(){_this3.setState({showFlash:false})},5000)})}},{key:'getAllDaysInMonth',value:function getAllDaysInMonth(month,year){return Array.from({length:new Date(year,month+1,0).getDate()},function(_,i){return new Date(year,month,i+1)})}},{key:'slotClickEvent',value:function slotClickEvent(slot,slot_id){console.log('target id:',this.state.target_id);console.log('slot:',slot);if(this.state.target_id){!slot&&this.setState({new_resa_modal:true,form:Object.assign({},this.state.form,{id:slot_id})})}else{slot&&this.setState({appointment_details_modal:true,appointment_detailed:slot})}}},{key:'getSelectedYear',value:function getSelectedYear(idx){var today=new Date;var is_next_year=idx>11&&this.state.year<=today.getFullYear();var is_prev_year=idx<=11&&this.state.year>today.getFullYear();// return this.state.year + (is_next_year ? Math.trunc(idx / 11) : (is_prev_year ? Math.trunc(idx / 11) * -1 : 0))
return this.state.year+(is_next_year?1:is_prev_year?-1:0)}},{key:'getSlotClickableClass',value:function getSlotClickableClass(slot){var is_clickable=this.state.target_id&&!slot||!this.state.target_id&&slot;return is_clickable?' clickable':''}},{key:'resNewSlot',value:function resNewSlot(){var _this4=this;http.post('/new-resa',{id:this.state.form.id,resa:this.state.form,user_id:this.state.target_user.id}).then(function(res){var schedule=_this4.state.schedule;schedule[_this4.state.form.id]=_this4.state.form;_this4.showFlashMessage('success','Votre rendez-vous a bien \xE9t\xE9 enregistr\xE9.');_this4.setState({schedule:schedule})}).catch(function(err){_this4.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}},{key:'buildResaId',value:function buildResaId(date,hour){var resa_date=new Date(date);resa_date.setHours(hour,0,0);return resa_date.toLocaleString()}},{key:'render',value:function render(){var _this5=this;var detailsForm=[React.createElement('div',{key:'duration',className:'details-duration-section'},React.createElement('div',{className:'details-duration-label'},'Dur\xE9e:'),React.createElement('div',{className:'details-duration-value'},this.state.appointment_detailed.duration)),React.createElement('div',{key:'isVideo',className:'details-isVideo-section'},React.createElement('div',{className:'details-isVideo-label'},'Visio-conf\xE9rence:'),React.createElement('div',{className:'details-isVideo-value'},this.state.appointment_detailed.isVideo?'Oui':'Non')),React.createElement('div',{key:'visioLink',className:'details-visioLink-section'+(this.state.appointment_detailed.isVideo?'':' hidden')},React.createElement('div',{className:'details-visioLink-label'},'Lien de la visio-conf\xE9rence:'),React.createElement('div',{className:'details-visioLink-value'},this.state.appointment_detailed.isVideo?'http://superlienvideo.caramel':''))];var scheduleForm=[React.createElement('div',{key:'duration',className:'input-group select-input'},React.createElement('label',{className:'input-label'},'Dur\xE9e'),React.createElement('select',{onChange:function onChange(e){_this5.setState({form:Object.assign({},_this5.state.form,{duration:e.target.value})})},name:'duration',className:'infos-form-select duration-select'},React.createElement('option',{value:'30'},'30min'),React.createElement('option',{value:'45'},'45min'),React.createElement('option',{value:'60'},'1h'))),React.createElement('div',{key:'isVideo',className:'input-group radio-group'},React.createElement('label',{className:'input-label'},'Visio-conf\xE9rence'),React.createElement('div',{className:'radio-choices',onChange:function onChange(e){_this5.setState({form:Object.assign({},_this5.state.form,{isVideo:e.target.value})})}},React.createElement('label',{className:'radio-label',htmlFor:'isVideo'},'Oui'),React.createElement('input',{type:'radio',defaultChecked:true,value:true,id:'isVideo',name:'isVideo',className:'cl-radio'}),React.createElement('label',{className:'radio-label',htmlFor:'isNotVideo'},'Non'),React.createElement('input',{id:'isNotVideo',value:false,name:'isVideo',type:'radio',className:'cl-radio'}))),React.createElement('div',{key:'sendbtn',className:'input-group'},React.createElement('div',{className:'button-group'},React.createElement('button',{onClick:function onClick(){_this5.resNewSlot();_this5.setState({new_resa_modal:false})},className:'cl-button primary'},'Valider')))];var this_month_days=this.getAllDaysInMonth(this.state.month,this.state.year);var today=new Date;console.log('agenda keys',Object.keys(this.state.schedule));return React.createElement('div',{className:'new-agenda-wrapper'},React.createElement(Navbar,{user:this.state.user,blue_bg:true}),React.createElement(Modal,{toggle:this.state.new_resa_modal,closeFunc:function closeFunc(){_this5.setState({new_resa_modal:false})},fields:scheduleForm,title:'Prendre un RDV',id:'appointment'}),React.createElement(Modal,{toggle:this.state.appointment_details_modal,closeFunc:function closeFunc(){_this5.setState({appointment_details_modal:false})},fields:detailsForm,title:'Votre RDV',id:'appointment-details'}),React.createElement('div',{className:'flash-message text-3 '+(this.state.showFlash?' '+this.state.flashType:' hidden')},this.state.flashMessage),React.createElement('h1',{className:'page-title blue-bg '+(this.state.target_id?'':'hidden')},'Agenda de\xA0',React.createElement('span',{className:'agenda-name-white'},this.state.target_user.firstname+' '+this.state.target_user.lastname)),React.createElement('div',{className:'new-agenda-container'},React.createElement('h1',{className:'new-agenda-title text-1'},this.state.months[this.state.month]),React.createElement('div',{className:'new-agenda-header'},this.state.months.concat(this.state.months).map(function(month,idx){return React.createElement('div',{key:idx,className:'new-agenda-header-month text-2 '+(_this5.state.month+(_this5.state.year-today.getFullYear())*12==idx&&' selected'||''),onClick:function onClick(){_this5.setState({month:idx%12,year:_this5.getSelectedYear(idx)})}},React.createElement('div',{className:'new-agenda-month-letter'},month.at(0).toUpperCase()),React.createElement('div',{className:'new-agenda-month-number'},_this5.state.months.indexOf(month)+1))})),React.createElement('div',{className:'new-schedule-container'},React.createElement('div',{className:'new-days-schedule-container'},this.state.weekdays.map(function(weekday,idx){return React.createElement('div',{key:idx,className:'new-agenda-days-row'},React.createElement('div',{className:'new-agenda-days-header text-2'},weekday.at(0).toUpperCase()),(this_month_days||[]).filter(function(date){return date.getDay()-1==idx||date.getDay()==0&&idx==6}).map(function(this_month_weekday,idx){var date=this_month_weekday.getDate();console.log(this_month_weekday.getTime());// console.log(this.state.day.getTime())
console.log(this_month_weekday.getTime()==_this5.state.day.getTime());return React.createElement('div',{key:idx,className:'new-agenda-day text-3'+(this_month_weekday.getTime()==_this5.state.day.getTime()?' selected bold-font':''),onClick:function onClick(){_this5.setState({day:new Date(_this5.state.year,_this5.state.month,date)})}},date)}))})),React.createElement('div',{className:'hours-schedule-container'},this.state.hours.map(function(hour,idx){console.log(slot_id);var slot_id=_this5.buildResaId(_this5.state.day,hour);var slot=_this5.state.schedule[slot_id]||idx==3;var appointment_message=slot&&!_this5.state.target_id?'Session coaching Mme Martin':'';return React.createElement('div',{key:idx,className:'hour-schedule'},React.createElement('div',{className:'hour-schedule-item text-2-5'},hour+':00'),React.createElement('div',{className:'appointment-schedule-item text-2-5 '+(slot?'reserved':'empty')+_this5.getSlotClickableClass(slot),onClick:function onClick(){_this5.slotClickEvent(slot,slot_id)}},appointment_message))})))))}}]);return Agenda}(React.Component);var domContainer=document.querySelector('.page-wrapper');ReactDOM.render(React.createElement(Agenda,null),domContainer);// let cellClass = "schedule-cell-content "
// let firstDate = this.state.currentWeek ? this.state.currentWeek[0].getDate() : ""
// let lastDate = this.state.currentWeek ? this.state.currentWeek[6].getDate() : ""
// let lastDateMonth = this.state.currentWeek ? this.state.currentWeek[6].getMonth() : ""
// let lastDateYear = this.state.currentWeek ? this.state.currentWeek[6].getFullYear() : ""
// return (
//   <div>
//     <Navbar user={this.state.user} />
//     <div className="agenda-wrapper">
//       <div className={"flash-message text-3 " + (this.state.showFlash ? ` ${this.state.flashType}` : " hidden")} >{this.state.flashMessage}</div>
//       <h1 className="page-title">Agenda de&nbsp;<span className="agenda-name">{this.state.user.firstname + ' ' + this.state.user.lastname}</span></h1>
//       <h2 className="page-title">
//         Semaine du {firstDate} au {lastDate} {this.state.months[lastDateMonth]} {lastDateYear}    
//       </h2>
//       <div className="week-selectors">
//         <div onClick={() => {this.showPrevWeek()}} className="previous-week">&lt;&nbsp;Semaine précédente</div>
//         <div onClick={() => {this.showNextWeek()}} className="next-week">Semaine suivante&nbsp;&gt;</div>
//       </div>
//       <Modal toggle={this.state.new_resa_modal} closeFunc={() => {this.setState({new_resa_modal: false})}}
//         fields={scheduleForm} title="Prendre un RDV" id="appointment"/>
//       <Modal toggle={this.state.appointment_details_modal} closeFunc={() => {this.setState({appointment_details_modal: false})}}
//         fields={detailsForm} title="Votre RDV" id="appointment-details"/>
//       <div className="agenda-header">
//         <div className="agenda-header-section hour-column"></div>
//         { this.state.weekdays.map(day => {
//           return <div key={day} className="agenda-header-section">{day}</div> 
//         })}
//       </div>
//       <div className="agenda-content-wrapper">
//           <div className="agenda-content-column hour-column">
//             { this.state.hours.map(hour => {
//               return <div key={hour} className="hour-cell">{hour}h&nbsp;</div> 
//             })}
//           </div>
//           { this.state.weekdays.map(day => {
//             return (
//               <div key={day} className="agenda-content-column">
//                 { this.state.hours.map(hour => {
//                   let slot_id = this.buildResaId(day, hour)
//                   let slot = this.state.schedule[slot_id]
//                   return (
//                     <div key={hour} className="schedule-cell">
//                       <div onClick={() => { !slot
//                        ? this.setState({new_resa_modal: true, form: {...this.state.form, id: slot_id}})
//                       :  this.setState({appointment_details_modal: true, appointment_detailed: slot}) }}
//                         className={(!slot) && cellClass + ' empty' || cellClass}>
//                           { slot ? 
//                           `RDV de ${slot.duration}min ${["true", true].includes(slot.isVideo) ? "avec" : "sans"} visio-conférence`
//                           : "+"}
//                       </div>
//                     </div>
//                   )
//                 }) }
//               </div>
//             )
//           })}
//         </div>
//     </div>
// </div>
// )