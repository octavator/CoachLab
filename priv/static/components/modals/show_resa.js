import Modal from"../modal.js";import{TextInput,Button}from"../forms/inputs.js";class ShowResaModal extends React.Component{constructor(props){super(props);this.state={sessionTitle:this.props.appointment_detailed?.sessionTitle||"",address:this.props.appointment_detailed?.address||"",appointment_detailed:{},coached_ids:this.props.appointment_detailed?.coached_ids||[],search_user_name:"",show_users:false,matching_users:[]}}componentDidUpdate(prevProps){if(prevProps.appointment_detailed!==this.props.appointment_detailed){this.setState({address:this.props.appointment_detailed?.address,sessionTitle:this.props.appointment_detailed?.sessionTitle,coached_ids:this.props.appointment_detailed?.coached_ids})}}buildVideoId(){return!this.props.appointment_detailed.id?undefined:`/video?roomId=${encodeURIComponent(this.props.appointment_detailed.id)}`}subscribeResa(){http.get(`/api/subscribe-resa?id=${this.props.appointment_detailed.id}`).then(res=>{if(res.status!=200)return this.props.showFlashMessage("error","Une erreur inconnue est survenue.");this.props.updateResa({...this.props.appointment_detailed,coached_ids:[...this.props.appointment_detailed.coached_ids,this.props.user.id]});this.props.showFlashMessage("success","Vous \xEAtes bien inscrit \xE0 la s\xE9ance. N'oubliez pas de la r\xE9gler au moins 48h avant.")}).catch(err=>{this.props.showFlashMessage("error",err?.response?.data||"Une erreur inattendue est survenue.")})}getMatchingUsers(input){if(input.length>=1){http.get(`/users/search?user_name=${encodeURIComponent(input)}&coach_id=${this.props.appointment_detailed.coach_id}`).then(res=>{if(res.data.length>0)this.setState({matching_users:res.data.filter(u=>!this.state.coached_ids?.includes(u.id)),show_users:true})}).catch(err=>{this.props.showFlashMessage("error",err?.response?.data||"Une erreur inattendue est survenue.")})}else this.setState({show_users:false});this.setState({search_user_name:input})}displayCoachedInvite(){if(this.props.user?.role!="coach")return false;return this.props.appointment_detailed?.isMulti||this.props.appointment_detailed?.coached_ids==0}updateResa(){http.post("/api/update-resa",{id:this.props.appointment_detailed.id,sessionTitle:this.state.sessionTitle,address:this.state.address,coached_ids:this.state.coached_ids}).then(res=>{if(res.status!=200)return this.props.showFlashMessage("error","Une erreur inconnue est survenue.");this.props.updateResa({...this.props.appointment_detailed,sessionTitle:this.state.sessionTitle,address:this.state.address,coached_ids:this.state.coached_ids});this.props.showFlashMessage("success","Votre rendez-vous a bien \xE9t\xE9 modifi\xE9.")}).catch(err=>{this.props.showFlashMessage("error",err?.response?.data||"Une erreur inattendue est survenue.")})}render(){let fields=[/*#__PURE__*/React.createElement("div",{key:"sessionTitle"},/*#__PURE__*/React.createElement(TextInput,{value:this.state.sessionTitle,onChange:e=>{this.setState({sessionTitle:e})},label:"Nom de la s\xE9ance:",bold_label:"true",disabled:this.props.appointment_detailed.coach_id!=this.props.user.id,extraClass:" white-bg",Placeholder:"Th\xE8me de la session"}),","),/*#__PURE__*/React.createElement("div",{key:"duration"},/*#__PURE__*/React.createElement("div",{className:"bold mt-1 mb-1"},"Dur\xE9e:"),/*#__PURE__*/React.createElement("div",null,this.props.appointment_detailed.duration+" min")),/*#__PURE__*/React.createElement("div",{key:"isVideo"},/*#__PURE__*/React.createElement("div",{className:"bold mb-1 mt-1"},"Visio-conf\xE9rence:"),/*#__PURE__*/React.createElement("div",null,this.props.appointment_detailed.isVideo?"Oui":"Non")),/*#__PURE__*/React.createElement("div",{className:this.props.appointment_detailed.isVideo?"hidden":"",key:"adresse"},/*#__PURE__*/React.createElement("div",{className:"bold mb-1 mt-1"},"Lieu:"),/*#__PURE__*/React.createElement("div",null,this.props.appointment_detailed.address)),/*#__PURE__*/React.createElement("div",{key:"isMulti"},/*#__PURE__*/React.createElement("div",{className:"bold mb-1 mt-1"},"S\xE9ance de groupe:"),/*#__PURE__*/React.createElement("div",null,this.props.appointment_detailed.isMulti?"Oui":"Non")),/*#__PURE__*/React.createElement("div",{key:"visioLink",className:`details-visioLink-section ${this.props.appointment_detailed.isVideo&&this.buildVideoId()?"":" hidden"}`},/*#__PURE__*/React.createElement("div",{className:"bold mb-1 mt-1"},"Lien de la visio-conf\xE9rence:"),/*#__PURE__*/React.createElement("div",{className:"clab-link",onClick:()=>window.open(`${this.buildVideoId()}`,"_blank")},"Cliquez ici pour rejoindre")),/*#__PURE__*/React.createElement("div",{key:"address",className:`details-address-section ${this.props.appointment_detailed.isVideo?"hidden":""}`},/*#__PURE__*/React.createElement("div",{className:"bold mb-1 mt-1"}),/*#__PURE__*/React.createElement(TextInput,{value:this.state.address,onChange:e=>{this.setState({address:e})},label:"Adresse de la s\xE9ance:",bold_label:"true",disabled:this.props.appointment_detailed.coach_id!=this.props.user.id,extraClass:`white-bg ${this.props.appointment_detailed.isVideo?"hidden":""}`,Placeholder:"Th\xE8me de la session"}),","),/*#__PURE__*/React.createElement("div",{key:"payment",className:`details-payment-section ${this.props.appointment_detailed.paid?.includes(this.props.user.id)||this.props.appointment_detailed.coach_id==this.props.user.id?" hidden":""}`},/*#__PURE__*/React.createElement("div",{className:"bold mb-1 mt-1"},"Lien de paiement de la session:"),/*#__PURE__*/React.createElement("div",{className:"clab-link",onClick:()=>window.open(`${this.props.payment_link}`,"_blank")},"Cliquez ici pour payer")),/*#__PURE__*/React.createElement("div",{className:`select-input-autocomplete-container ${this.displayCoachedInvite()?"":"hidden"}`},/*#__PURE__*/React.createElement(TextInput,{bold_label:true,label:"Invitez un coach\xE9",extraClass:"text-3 autocomplete-text-input white-bg",value:this.state.search_user_name,placeholder:"Nom du coach\xE9",onChange:e=>{this.getMatchingUsers(e)}}),/*#__PURE__*/React.createElement("div",{className:`select-autocomplete-wrapper labeled ${this.state.show_users?"":"hidden"}`},this.state.matching_users.map(matching_user=>/*#__PURE__*/React.createElement("div",{key:matching_user.id,className:"select-autocomplete-option text-3",onClick:()=>this.setState({search_user_name:`${matching_user.firstname} ${matching_user.lastname}`,coached_ids:[...this.state.coached_ids,matching_user.id],show_users:false})},`${matching_user.firstname} ${matching_user.lastname}`)))),/*#__PURE__*/React.createElement("div",{className:"input-group"},/*#__PURE__*/React.createElement(Button,{extraClass:"cl-button mt-2",onClick:()=>{this.props.user.id==this.props.appointment_detailed.coach_id?this.updateResa():this.subscribeResa();this.setState({sessionTitle:this.props.appointment_detailed?.sessionTitle||"",address:this.props.appointment_detailed?.address||"",appointment_detailed:{},coached_ids:this.props.appointment_detailed?.coached_ids||[],search_user_name:"",show_users:false,matching_users:[]})},text:"Valider"}))];return/*#__PURE__*/React.createElement(Modal,{toggle:this.props.toggle,closeFunc:()=>this.props.closeFunc(),fields:fields,title:"Votre RDV",id:"appointment-details"})}}export default ShowResaModal;