var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}import Modal from'./modal.js';import Navbar from'./navbar.js';import Flash from'./flash.js';import scrollTo from'../utils.js';import{SelectInput,RadioButton,TextInput,Button}from'./forms/inputs.js';//@TODO: allow to select a month from another year than current
var Agenda=function(_React$Component){_inherits(Agenda,_React$Component);function Agenda(props){_classCallCheck(this,Agenda);var _this=_possibleConstructorReturn(this,(Agenda.__proto__||Object.getPrototypeOf(Agenda)).call(this,props));_this.state={new_resa_modal:false,can_edit_new_resa:true,can_edit_new_resa_name:false,appointment_details_modal:false,target_id:undefined,schedule:{},day:new Date(new Date().setHours(0,0,0,0)),month:new Date().getMonth(),year:new Date().getFullYear(),showFlash:false,flashType:'',flashMessage:'',coached_users:{},reservations:{},appointment_detailed:{},form:_this.defaultForm(),user:{firstname:'',lastname:''},target_user:{firstname:'',lastname:''},weekdays:['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'],hours:['8','9','10','11','12','13','14','15','16','17','18','19','20','21'],months:['Janvier','F\xE9vrier','Mars','Avril','Mai','Juin','Juillet','Ao\xFBt','Septembre','Octobre','Novembre','D\xE9cembre'],durations:[{label:'30min',value:'30'},{label:'45min',value:'45'},{label:'1h',value:'60'},{label:'1h30',value:'90'}]};return _this}_createClass(Agenda,[{key:'componentDidMount',value:function componentDidMount(){var _this2=this;var urlParams=new URLSearchParams(document.location.search);var target_id=urlParams.get('target_id');scrollTo('.new-agenda-header','.new-agenda-header-month:nth-child('+this.state.day.getDate()+')');if(!target_id){http.get('/api/me/agenda').then(function(agendaData){_this2.setState({schedule:agendaData.data.agenda,user:agendaData.data.user})}).catch(function(err){_this2.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}else{http.get('/api/me').then(function(res){http.get('/api/coach/agenda/'+target_id).then(function(agendaData){_this2.setState({target_user:agendaData.data.user,schedule:agendaData.data.agenda,target_id:target_id,user:res.data,form:Object.assign({},_this2.state.form)})}).catch(function(err){_this2.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}).catch(function(err){_this2.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}}},{key:'showFlashMessage',value:function showFlashMessage(type,message){var _this3=this;this.setState({showFlash:true,flashMessage:message,flashType:type},function(){setTimeout(function(){_this3.setState({showFlash:false})},5000)})}},{key:'getAllDaysInMonth',value:function getAllDaysInMonth(month,year){return Array.from({length:new Date(year,month+1,0).getDate()},function(_,i){return new Date(year,month,i+1)})}},{key:'slotClickEvent',value:function slotClickEvent(slot,slot_id){if(this.getSlotClickableClass(slot)=='')return;//my agenda
if(!this.state.target_id)return slot&&this.setState({appointment_details_modal:true,appointment_detailed:slot});//my coach agenda
if(!slot)this.setState({new_resa_modal:true,can_edit_new_resa:true,form:Object.assign({},this.state.form,{id:slot_id})});else this.setState({new_resa_modal:true,can_edit_new_resa:false,form:Object.assign({},slot,{id:slot_id})})}},{key:'buildVideoId',value:function buildVideoId(){return!this.state.appointment_detailed.id?undefined:'/video?roomId='+encodeURIComponent(this.state.appointment_detailed.id)}},{key:'getSelectedYear',value:function getSelectedYear(idx){var today=new Date;var is_next_year=idx>11&&this.state.year<=today.getFullYear();var is_prev_year=idx<=11&&this.state.year>today.getFullYear();// return this.state.year + (is_next_year ? Math.trunc(idx / 11) : (is_prev_year ? Math.trunc(idx / 11) * -1 : 0))
return this.state.year+(is_next_year?1:is_prev_year?-1:0)}},{key:'getSlotClickableClass',value:function getSlotClickableClass(slot){var ownExistingSlot=!this.state.target_id&&slot;var coachOpenSlot=!slot||slot.isMulti;var is_clickable=this.state.user.role!='coach'&&this.state.target_id&&coachOpenSlot||ownExistingSlot;return is_clickable?' clickable':''}},{key:'resNewSlot',value:function resNewSlot(){var _this4=this;var ids=this.state.user.role=='coach'?[]:[this.state.user.id];http.post('/new-resa',{id:this.state.form.id,resa:Object.assign({},this.state.form,{coached_ids:ids}),user_id:this.state.target_user.id}).then(function(res){if(res.status!=200)return _this4.showFlashMessage('error','Une erreur inconnue est survenue.');var schedule=_this4.state.schedule;schedule[_this4.state.form.id]=_this4.state.form;_this4.showFlashMessage('success','Votre rendez-vous a bien \xE9t\xE9 enregistr\xE9.');_this4.setState({schedule:schedule})}).catch(function(err){_this4.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}},{key:'updateRes',value:function updateRes(){var _this5=this;http.post('/update-resa',{id:this.state.appointment_detailed.id,sessionTitle:this.state.appointment_detailed.sessionTitle}).then(function(res){if(res.status!=200)return _this5.showFlashMessage('error','Une erreur inconnue est survenue.');_this5.showFlashMessage('success','Votre rendez-vous a bien \xE9t\xE9 enregistr\xE9.');_this5.setState({reservations:Object.assign({},reservations,_defineProperty({},key,_this5.state.appointment_detailed))})}).catch(function(err){_this5.showFlashMessage('error',err.response.data||'Une erreur inattendue est survenue.')})}},{key:'getAppointmentTitle',value:function getAppointmentTitle(slot){if(!slot)return'';if(slot.isMulti)return slot.sessionTitle!=''?slot.sessionTitle:'Session de groupe';if(this.state.target_id&&!slot.coached_ids.includes(this.state.user.id))return'';return'Session avec '+(slot.coached_ids.includes(this.state.user.id)&&'vous'||this.state.coached_users[slot.coached_ids[0]])}},{key:'buildResaId',value:function buildResaId(date,hour){var resa_date=new Date(date);resa_date.setHours(hour,0,0);var coach_id=this.state.target_id?this.state.target_id:this.state.user.id;return resa_date.toLocaleString('fr-FR',{timeZone:'UTC'})+'+'+coach_id}},{key:'defaultForm',value:function defaultForm(){return{duration:'60',isVideo:true,isMulti:false,sessionTitle:'',id:''}}},{key:'render',value:function render(){var _this6=this;var detailsForm=[React.createElement(TextInput,{value:this.state.appointment_detailed.sessionTitle,onChange:function onChange(e){_this6.setState({appointment_detailed:Object.assign({},_this6.state.appointment_detailed,{sessionTitle:e})})},label:'Nom de la s\xE9ance',disabled:!this.state.user.role=='coach',extraClass:' white-bg'}),React.createElement('div',{key:'duration'},React.createElement('div',{className:'bold mt-1'},'Dur\xE9e:'),React.createElement('div',null,this.state.appointment_detailed.duration+'min')),React.createElement('div',{key:'isVideo'},React.createElement('div',{className:'bold mt-1'},'Visio-conf\xE9rence:'),React.createElement('div',null,this.state.appointment_detailed.isVideo?'Oui':'Non')),React.createElement('div',{key:'isMulti'},React.createElement('div',{className:'bold mt-1'},'S\xE9ance de groupe:'),React.createElement('div',null,this.state.appointment_detailed.isMulti?'Oui':'Non')),React.createElement('div',{key:'visioLink',className:'details-visioLink-section '+(this.state.appointment_detailed.isVideo&&this.buildVideoId()?'':' hidden')},React.createElement('div',{className:'bold mt-1'},'Lien de la visio-conf\xE9rence:'),React.createElement('div',{className:'clab-link',onClick:function onClick(){return window.open(''+_this6.buildVideoId(),'_blank')}},'Cliquez ici pour rejoindre')),React.createElement('div',{className:'input-group'},React.createElement(Button,{extraClass:'cl-button mt-2',onClick:function onClick(){return _this6.updateRes()},text:'Editer'}))];var scheduleForm=[React.createElement(TextInput,{value:this.state.form.sessionTitle,onChange:function onChange(e){_this6.setState({form:Object.assign({},_this6.state.form,{sessionTitle:e})})},label:'Nom de la s\xE9ance',disabled:!this.state.can_edit_new_resa&&!this.state.can_edit_new_resa_name,extraClass:' white-bg',Placeholder:'Session fitness pour d\xE9butants'}),React.createElement(SelectInput,{value:this.state.durations.find(function(d){return d.value==_this6.state.form.duration}).label,disabled:!this.state.can_edit_new_resa,options:this.state.durations.map(function(duration){return{label:duration.label,value:duration.value}}),onClick:function onClick(e){_this6.setState({form:Object.assign({},_this6.state.form,{duration:e})})},label:'Dur\xE9e'}),React.createElement(RadioButton,{value:this.state.form.isVideo,onClick:function onClick(e){_this6.setState({form:Object.assign({},_this6.state.form,{isVideo:e})})},label:'Visio-conf\xE9rence ?',yesLabel:'Oui',noLabel:'Non',disabled:!this.state.can_edit_new_resa}),React.createElement(RadioButton,{value:this.state.form.isMulti,onClick:function onClick(e){_this6.setState({form:Object.assign({},_this6.state.form,{isMulti:e})})},label:'S\xE9ance de groupe ?',yesLabel:'Oui',noLabel:'Non',disabled:!this.state.can_edit_new_resa}),React.createElement('div',{className:'input-group'},React.createElement(Button,{extraClass:'cl-button mt-2',onClick:function onClick(){_this6.resNewSlot();_this6.setState({new_resa_modal:false,form:_this6.defaultForm()})},text:'Valider'}))];var this_month_days=this.getAllDaysInMonth(this.state.month,this.state.year);return React.createElement('div',{className:'new-agenda-wrapper'},React.createElement(Navbar,{user:this.state.user,blue_bg:true}),React.createElement(Modal,{toggle:this.state.new_resa_modal,closeFunc:function closeFunc(){return _this6.setState({new_resa_modal:false,form:_this6.defaultForm()})},fields:scheduleForm,title:'Prendre un RDV',id:'appointment'}),React.createElement(Modal,{toggle:this.state.appointment_details_modal,closeFunc:function closeFunc(){return _this6.setState({appointment_details_modal:false})},fields:detailsForm,title:'Votre RDV',id:'appointment-details'}),React.createElement(Flash,{showFlash:this.state.showFlash,flashType:this.state.flashType,flashMessage:this.state.flashMessage}),React.createElement('h1',{className:'page-title blue-bg '+(this.state.target_id?'':'hidden')},'Agenda de\xA0',React.createElement('span',{className:'agenda-name-white'},this.state.target_user.firstname+' '+this.state.target_user.lastname)),React.createElement('div',{className:'new-agenda-container'},React.createElement('h1',{className:'new-agenda-title text-1'},React.createElement(SelectInput,{extraClass:'text-2 ',value:this.state.months[this.state.month],options:this.state.months.map(function(month,idx){return{label:month,value:idx}}),onClick:function onClick(e){_this6.setState({month:e})}})),React.createElement('div',{className:'new-agenda-header'},this_month_days.map(function(month_day,idx){return React.createElement('div',{key:idx,onClick:function onClick(){_this6.setState({day:month_day})},className:'new-agenda-header-month text-2 '+(_this6.state.day.getDate()==idx+1&&_this6.state.day.getMonth()==_this6.state.month?'selected':'')},React.createElement('div',{className:'new-agenda-month-letter'},_this6.state.weekdays[month_day.getDay()].at(0).toUpperCase()),React.createElement('div',{className:'new-agenda-month-number'},month_day.getDate()))})),React.createElement('div',{className:'hours-schedule-container'},this.state.hours.map(function(hour,idx){var slot_id=_this6.buildResaId(_this6.state.day,hour);var resa_id=_this6.state.schedule[slot_id];console.log(slot_id,'slot_id');console.log(_this6.state.schedule,'agenda');console.log(_this6.state.reservations,'resas');console.log(resa_id,'resa_id');//get resa and display
if(resa_id&&!_this6.state.reservations[resa_id]){http.get('/api/reservation/'+encodeURIComponent(resa_id)).then(function(res){if(!res.data.isMulti){http.get('/user/'+res.data.coached_ids[0]).then(function(user_data){_this6.setState({coached_users:Object.assign({},_this6.state.coached_users,_defineProperty({},res.data.coached_ids[0],user_data.data.firstname+' '+user_data.data.lastname))})})}_this6.setState({reservations:Object.assign({},_this6.state.reservations,_defineProperty({},resa_id,res.data))})})}var slot=_this6.state.reservations[resa_id];var appointment_message=_this6.getAppointmentTitle(slot);return React.createElement('div',{key:idx,className:'hour-schedule'},React.createElement('div',{className:'hour-schedule-item text-2-5'},hour+':00'),React.createElement('div',{className:'appointment-schedule-item text-2-5 '+(resa_id?'reserved ':'empty ')+_this6.getSlotClickableClass(resa_id),onClick:function onClick(){return _this6.slotClickEvent(slot,slot_id)}},React.createElement('div',null,appointment_message),React.createElement('div',{className:'appointment-pictos '+(slot&&(slot.isMulti||!_this6.state.target_id)?'':'hidden')},React.createElement('div',{className:'appointment-picto '+(slot&&(slot.isMulti?'multi':'single'))},React.createElement('img',{src:'priv/static/images/'+(slot&&slot.isMulti?'session_groupe.svg':'session_individuelle.svg')})),React.createElement('div',{className:'appointment-picto video'},React.createElement('img',{src:'priv/static/images/'+(slot&&slot.isVideo?'session_online.svg':'session_irl.svg')})))))}))))}}]);return Agenda}(React.Component);var domContainer=document.querySelector('.page-wrapper');ReactDOM.render(React.createElement(Agenda,null),domContainer);{}/* OLD CALENDAR *///   <div className="new-days-schedule-container">
//   {
//     this.state.weekdays.map((weekday, idx) => {
//       return (
//         <div key={idx} className={"new-agenda-days-row"}>
//           <div className="new-agenda-days-header text-2">{weekday.at(0).toUpperCase()}</div>
//           {
//             (this_month_days || []).filter(date => date.getDay() == idx + 1 || date.getDay() == 0 && idx == 6 )
//             .map((this_month_weekday, idx) => {
//               const date = this_month_weekday.getDate()                          
//               return (
//                 <div key={idx} className={"new-agenda-day text-3" + ((this_month_weekday.getTime() == this.state.day.getTime()) ? " selected bold-font" : "")}
//                  onClick={() => {this.setState({day: new Date(this.state.year, this.state.month, date)})}}>
//                   {date}
//                 </div>
//               )
//             })
//           }
//         </div>
//       )
//     })
//   }
// </div>