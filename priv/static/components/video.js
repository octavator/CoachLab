var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}import Navbar from'./navbar.js';import Flash from'./flash.js';var Video=Twilio.Video;var ClabVideo=function(_React$Component){_inherits(ClabVideo,_React$Component);function ClabVideo(props){_classCallCheck(this,ClabVideo);var _this=_possibleConstructorReturn(this,(ClabVideo.__proto__||Object.getPrototypeOf(ClabVideo)).call(this,props));var urlParams=new URLSearchParams(document.location.search);var roomId=urlParams.get('roomId');_this.state={user:{firstname:'',lastname:'',role:'coach'},roomId:roomId,sendAudio:true,sendVideo:true,room:undefined,schedule:{},tracks:[],token:'',showFlash:false,flashType:'',flashMessage:''};return _this}_createClass(ClabVideo,[{key:'componentDidMount',value:function componentDidMount(){var _this2=this;http.get('/api/me/agenda').then(function(agendaData){//@TODO: empecher un mec de rentrer dans la room s'il a pas payé
var resId=_this2.state.roomId.split('+')[0];var resa=agendaData.data.agenda[resId];//@TODO: Gérer room type en créant la room plutot que ad hoc connect
var roomType=resa.isMulti?'group':'go';if(Video.isSupported){http.get('/video-token').then(function(token){Video.createLocalVideoTrack().then(function(track){return document.getElementById('local-media').appendChild(track.attach())});_this2.setState({schedule:agendaData.data.agenda,user:agendaData.data.user,token:token.data,roomType:roomType})})}else _this2.showFlashMessage('error','Votre navigateur actuel n\'est pas compatible avec notre module vid\xE9o.')}).catch(function(err){_this2.showFlashMessage('error',err.response&&err.response.data||'Une erreur inattendue est survenue.')})}},{key:'showFlashMessage',value:function showFlashMessage(type,message){var _this3=this;this.setState({showFlash:true,flashMessage:message,flashType:type},function(){setTimeout(function(){_this3.setState({showFlash:false})},5000)})}},{key:'getRemoteTracks',value:function getRemoteTracks(participant){var _this4=this;participant.tracks.forEach(function(publication){if(publication.track){var tracks=[].concat(_toConsumableArray(_this4.state.tracks));// let tracks = [...this.state.tracks].filter(track => { console.log(new_track.name, track.name) ;track.name != new_track.name })
_this4.setState({tracks:tracks.concat([publication.track])})}});participant.on('trackSubscribed',function(new_track){var tracks=[].concat(_toConsumableArray(_this4.state.tracks));console.log('new track name',new_track.name);console.log('is already in room ?',tracks.some(function(t){return t.name==new_track.name}));// let tracks = [...this.state.tracks].filter(track => { console.log(new_track.name, track.name) ;track.name != new_track.name })
_this4.setState({tracks:tracks.concat([new_track])})})}},{key:'startVideoLive',value:function startVideoLive(){var _this5=this;Video.connect(this.state.token,{name:this.state.roomId,audio:{name:'audio+'+this.state.user.id+'+'+this.state.user.firstname+' '+this.state.user.lastname},video:{name:'video+'+this.state.user.id+'+'+this.state.user.firstname+' '+this.state.user.lastname},type:this.state.roomType}).then(function(room){room.participants.forEach(function(participant){return _this5.getRemoteTracks(participant)});room.on('participantConnected',function(participant){return _this5.getRemoteTracks(participant)});if(!_this5.state.sendAudio){room.localParticipant.audioTracks.forEach(function(publication){publication.track.disable()})}if(!_this5.state.sendVideo){room.localParticipant.videoTracks.forEach(function(publication){publication.track.disable()})}_this5.setState({room:room,hasJoined:true})},function(error){_this5.showFlashMessage('error',error.message||'Une erreur inattendue est survenue.')})}},{key:'toggleAudio',value:function toggleAudio(){var _this6=this;this.setState({sendAudio:!this.state.sendAudio});if(!this.state.room)return;this.state.room.localParticipant.audioTracks.forEach(function(publication){if(_this6.state.sendAudio)publication.track.disable();else publication.track.enable()})}},{key:'toggleVideo',value:function toggleVideo(){var new_sendVideo=this.state.sendVideo?false:{};this.setState({sendVideo:new_sendVideo});if(!this.state.room)return;this.state.room.localParticipant.videoTracks.forEach(function(publication){if(new_sendVideo)publication.track.enable();else publication.track.disable()})}},{key:'toggleTrack',value:function toggleTrack(isDisabled,trackId){var new_tracks=this.state.tracks.map(function(t){if(t.sid==trackId)return Object.assign({},t,{disabled:isDisabled});return t});this.setState({tracks:new_tracks})}},{key:'handleTrackToggle',value:function handleTrackToggle(track){var _this7=this;track.on('disabled',function(){return _this7.toggleTrack(true,track.sid)});track.on('enabled',function(){return _this7.toggleTrack(false,track.sid)})}},{key:'attachTracks',value:function attachTracks(type){var _this8=this;this.state.tracks.filter(function(track){return track.kind==type}).forEach(function(track,idx){var target=document.getElementById('remote-'+type+'-'+idx);var isAttached=document.querySelector('#remote-'+type+'-'+idx+' '+type);if(!target||isAttached)return;target.appendChild(track.attach());_this8.handleTrackToggle(track)})}},{key:'componentDidUpdate',value:function componentDidUpdate(){this.attachTracks('video');this.attachTracks('audio')}},{key:'render',value:function render(){var _this9=this;// @TODO: tester puis repliquer le component Flash sur les autres pages
// this.showFlashMessage("error", "coucou ca marche ?")
//@TODO: when more than 4 ppl in room, only show the coach's video
console.log(this.state.tracks,'tracks');return React.createElement('div',null,React.createElement(Navbar,{blue_bg:true,user:this.state.user}),React.createElement(Flash,{showFlash:this.state.showFlash,flashType:this.state.flashType,flashMessage:this.state.flashMessage}),React.createElement('div',{className:'video'},React.createElement('div',{className:'video-wrapper'},React.createElement('div',{className:'local-media-video '+(this.state.sendVideo?'':'black-bg')},React.createElement('div',{id:'local-media',className:'local-media '+(this.state.sendVideo?'':'transparent'),style:{}})),this.state.tracks.filter(function(track){return track.kind=='audio'}).map(function(track,idx){return React.createElement('div',{key:''+track.name},React.createElement('div',{id:'remote-audio-'+idx,className:'remote-audio',style:{}}))}),this.state.tracks.filter(function(track){return track.kind=='video'}).map(function(track,idx){return React.createElement('div',{key:''+track.name,className:'participant-block '+(track.disabled?'hidden':'')},React.createElement('div',{id:'remote-video-'+idx,className:'remote-video',style:{}}))})),React.createElement('div',{className:'flex flex-center mt-2'},React.createElement('div',{onClick:function onClick(){_this9.toggleAudio()},className:'cl-button ml-2'},this.state.sendAudio?'D\xE9sactiver Audio':'Activer Audio'),React.createElement('div',{onClick:function onClick(){_this9.toggleVideo()},className:'cl-button ml-2'},this.state.sendVideo?'D\xE9sactiver Vid\xE9o':'Activer Vid\xE9o'),React.createElement('div',{onClick:function onClick(){_this9.startVideoLive()},className:'cl-button ml-2 '+(this.state.hasJoined?'hidden':'')},'Rejoindre la r\xE9union'))))}}]);return ClabVideo}(React.Component);var domContainer=document.querySelector('.page-wrapper');ReactDOM.render(React.createElement(ClabVideo,null),domContainer);